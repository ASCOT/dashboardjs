<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/css/reset.css"> 
    <link rel="stylesheet" href="/css/text.css"> 
    <link rel="stylesheet" href="/css/gadget.css">
    <link rel="stylesheet" href="/css/dashboardPanel.css"> 
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js" type="text/javascript"></script>
    <script src="/modernizr.custom.80028.js"></script>
    <script src="/underscore.js" type="text/javascript"></script>
    <script src="/backbone.js" type="text/javascript"></script>
    <script src="/chat.js" type="text/javascript"></script>
    <script src="/faye/faye.js" type="text/javascript"></script>
    <script src="/logs.js" type="text/javascript"></script>
    <script src="/util.js" type="text/javascript"></script>
    <script src="/gadget.js" type="text/javascript"></script>
    <script src="/layoutManager.js" type="text/javascript"></script>
    <script src="/dataSetModifier.js" type="text/javascript"></script> 
    <script src="/dataSet.js" type="text/javascript"></script> 
    <script src="/renderer.js" type="text/javascript"></script>
    <script src="/dashboard.js" type="text/javascript"></script>
    <script src="/xhr.js" type="text/javascript"></script> 
    
    <script type="text/javascript">

    var ASCOT = ASCOT || {};
    var dashboardId = {{id}};
    var resourceUrl = {{resourceUrl}};
    var closeAlertTimeout;

    $(function(){
      initDashboard();
    });
    
    var finishedLoading = function(){
      $('#loadingBar').toggle();
    }

    var initDashboard = function() {
      ASCOT.dashboard = new UW.Dashboard();
      ASCOT.dashboard.setContainer($("#" + 'dashboardPanel').get(0));
      ASCOT.dashboard.setUrl(resourceUrl + '/' + dashboardId);
      ASCOT.dashboard.init(finishedLoading);
      initGUI();
      return ASCOT.dashboard;
    };

    function saveDashboard() {
      //displayNote('ALERT');
      //showPopUp('popUp');
      ASCOT.dashboard.save();
    }
    
    function tabClicked(){
      if($(this).hasClass('opened')){
        return;
      }
      $('#tabsBar').children().removeClass('opened');
      $('#tabsBar').children().css('cursor','pointer');
      $('#tabsBar').children().hover(tabHoverIn, tabHoverOut);
      $(this).addClass('opened');
      $(this).unbind('mouseenter').unbind('mouseleave');
      $(this).css('border','1px solid rgba(0, 0, 0, 0.4)');
      $(this).css('cursor','auto');
      $(this).children().css('color','#464547');  
      
      $('#content').children().hide();
      switch($(this).attr('id')){
        case 'dashboardTab':
          $('#dashboardPanel').show();
          break;
        case 'dataSetsTab':
          $('#dataSetsPanel').show();
          break;
        case 'discussionTab':
          $('#discussionPanel').show();
          break;  
      } 
    }
    
    function tabHoverIn(){
      $(this).css('border','1px solid rgba(0, 0, 0, 1)'); 
      $(this).children().css('color','black');           
    }
    
    function tabHoverOut(){
      $(this).css('border','1px solid rgba(0, 0, 0, 0.4)');
      $(this).children().css('color','#464547');  
    }
    
    function closePopUpHoverIn(){
      $(this).css('background','url("/images/closePopUpHover.png")');      
    }
    
    function closePopUpHoverOut(){
      $(this).css('background','url("/images/closePopUp.png")');
    }

    function initGUI() {
      $('#closeNote').click(hideNote);
      $('.tab').click(tabClicked);
      $('.closePopUp').click(function() { hidePopUp('popUp') });
      $('.closePopUp').hover(closePopUpHoverIn, closePopUpHoverOut);
      $('.tab').hover(tabHoverIn, tabHoverOut);
      $('#tabsBar').children().css('cursor','pointer');
      $('#dashboardTab').css('cursor','auto'); 
      $('#dashboardTab').unbind('mouseenter').unbind('mouseleave');
      $(window).resize(function() { placePopUp('popUp') }); 
    }
    
    function hideNote(){
      $('#note').css('display','none');
      clearTimeout(closeAlertTimeout);
    }
    
    var displayNote = function(message, persistent){
      var note = $('#note');
      var newNote = note.clone(true);
      var closeButton = $('#closeNote');
      newNote.html('');
      newNote.append(message + " ");
      newNote.append(closeButton);
      note.before(newNote);
      newNote.toggle();
      $("." + note.attr('class') + ':last').remove();
      if(!persistent){
        closeAlertTimeout = setTimeout('hideNote()',2000);
      }
    }
    
    function placePopUp(popUpId){
      var popUp = $('#' + popUpId);
      var viewPortHeight = $(window).height();
      var viewPortWidth = $(window).width();      
      var popUpTop = (viewPortHeight - popUp.height())/2 - 200;
      var popUpLeft = (viewPortWidth - popUp.width())/2;
      var popUpMask = $('#popUpMask');
      popUp.css('top', popUpTop + 'px');
      popUp.css('left', popUpLeft + 'px');
      popUpMask.css('height', viewPortHeight + 'px');
    }
    
    function showPopUp(popUpId) {
      placePopUp(popUpId);      
      $('#popUpMask').toggle();     
      $('#' + popUpId).toggle();     
    }
    
    function hidePopUp(popUpId) {
      $('#popUpMask').toggle();     
      $('#' + popUpId).toggle(); 
    }
    </script>
  </head>
  <body>
    <div id="popUpMask" style="display: none"></div>
    <div id="popUp" style="display: none"><div class="closePopUp"></div></div>
    <div id="note" class="openNote" style="display: none"><a id="closeNote"></a></div>
    
    <table class="content" width="100%">
      <tr>
        <td colspan="2" class="header">
          <header>
              <div class="logo">
                <a href="/" title="Astronomical Collaborative Toolkit">Astronomical Collaborative Toolkit</a>
              </div>
              <nav class="header">
                <div class="buttonGroup">
                  <ul>
                    <li class="left" ><a href="#" title="undo" onClick="">Undo</a></li>
                    <li class="right"><a href="#" title="redo" onClick="">Redo</a></li>
                  </ul>
                </div>
                <div class="buttonGroup">
                  <ul>
                    <li><a href="#" title="saveDashboard" onClick="saveDashboard()">Save</a></li>
                  </ul>
                </div>
                <div class="buttonGroup">
                  <ul>
                    <li><a href="#" title="forkDashboard" onClick="displayNote('The dashboard has been forked')">Fork</a></li>
                  </ul>
                </div>
              </nav>
            </div>  
          </header>
        </td> 
      </tr>
      <tr>  
        <td id="toolBox">
          <div id="tabsBar">
            <div id="dashboardTab" class="tab opened"><div class="label">Dashboard</div></div> 
            <div id="dataSetsTab" class="tab"><div class="label">Data Sets</div></div> 
            <div id="discussionTab" class="tab"><div class="label">Discussion</div></div>  
          </div>
        </td> 
        <td id="content" class="content">
          <div id="dashboardPanel" class="content">
            <div id="loadingBar" style="width: 107px; margin: auto; margin-top: 210px"><img style="height: 19px; width: 107px" alt="dashboard loading" src='/images/loadingBar.gif'></div>
          </div>
          <div id="dataSetsPanel" class="content" style="display: none">
            DataSets Panel
          </div>
          <div id="discussionPanel" class="content" style="display: none">
            Discussion Panel
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="2" class="footer">
          <footer>
            <a href="http://uw.edu" style="float: right"><span class="uwLogo"></span> University of Washington</a>
          </footer>
        </td> 
      </tr>
    </table>
  </body>
</html>