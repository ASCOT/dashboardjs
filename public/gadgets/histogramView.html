<!-- Author: Spencer Wallace (spencerw@email.arizona.edu) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Pragma" content="no-cache">
<title>histogramView</title>
<!-- ASCOT Basic Style Sheets -->
<link href="/css/reset.css" rel="stylesheet" type="text/css">
<link href="/css/text.css" rel="stylesheet" type="text/css"> 
<link href="/css/widgets.css" rel="stylesheet" type="text/css"> 

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.js"></script>
<script src="/highcharts.src.js" type="text/javascript"></script>
<script src="/util.js" type="text/javascript"></script>

<script type="text/javascript">

var selectedDataSetId = ""; // The name of the dataset to be loaded
var selectedXAxis = "";
var selectedColor = "";
var numBins = 10;

gadget.init = function(callback){	
  gadget.onNotification('dataSetChanged', updateDataSetList);
  gadget.onNotification('pointsSelected', setSelectedColor);

  $('#selectDataSetName').change( function(){
    if(this.selectedIndex != -1){
      selectedDataSetId = $(this).find('option:selected').val();
      populateXSelect(this.options[this.selectedIndex].value);
    }
  });

  $('#selectXAxis').change( function(){
    if(this.selectedIndex != -1){
      selectedXAxis = $(this).find('option:selected').val();
    }
  });
  
  $('#selectColor').change( function(){
    if(this.selectedIndex != -1){
      selectedColor = $(this).find('option:selected').val();
    }
  });

  populateSelect("selectColor", ["red", "green", "blue", "yellow", "unselect"], selectedColor);
  callback();

};

gadget.saveState = function(){
  return { 
    "selectedDataSetId": selectedDataSetId,
    "selectedXAxis": selectedXAxis,
    "selectedColor": selectedColor,
    "numBins" : numBins
  }
};

gadget.loadState = function(state){

  selectedDataSetId = state.selectedDataSetId || "";
  selectedXAxis = state.selectedXAxis || "";
  selectedColor = state.selectedColor || "";
  redraw();

};

var DEFAULT_MARKER_COLOR = 'rgba(160, 160,160, 1)';
var SELECTED_MARKER_COLOR = 'rgba(210,30,100,.9)';
var MARKER_COLOR = { 
  red: 'rgba(255, 0, 0, .7)',
  green: 'rgba(0, 255, 0, .7)',
  blue: 'rgba(0, 0, 255, .7)',
  yellow: 'rgba(220, 220, 0, .7)',
  unselect: DEFAULT_MARKER_COLOR
};

var chart1;       // The highcharts chart object
var bins;				  // A 2d array containing the data points held in each bin
var dataToChart;	// The collection of points going into the histogram

// When the public dataset changes, update the histogram data    
var updateDataSetList = function(){
  populateSelect('selectDataSetName', gadget.dashboard.getDataSetList(), selectedDataSetId);
  updateSelectedPoints();
}

// Given a list of point ids, change those points in the public dataset to a given color
var setSelectedColor = function(obj) {
  var useColor = obj.color;
	if (obj.color == 'unselect') {
		useColor = '';
	}
	var ds = gadget.dashboard.getDataSet(selectedDataSetId);
	ds.setRecords({'color': useColor}, obj.modifiedPointIds);
  gadget.notify('dataSetListChanged');
	return;
};
	
// Checks the public dataset to update the selection status of all the points in the histogram
var updateSelectedPoints = function() {
	if(chart1 == null)
 		return;	
 	// select or unselect all the points in the chart to change the way they look
 	var ds = gadget.dashboard.getDataSet(selectedDataSetId);
 	if (ds === undefined || ds === null) {
	 	return;
	 }
 	var colorIndexArray = ds.getAttributeValues('color');
 	var colorIndex;
 	var point;
 	
 	for (color in colorIndexArray) {
 		colorIndex = colorIndexArray[color];
 		for (var i = 0; i < colorIndex.length; i++) {
 			point = dataToChart[colorIndex[i]];
 			colorChartPoint(point,color);
 		}
 	}
 	redraw();
}

// Colors a selected point in the histogram dataset by the color name
function colorChartPoint(point, colorName) {
    if (colorName === "") {
        colorName = "unselect";
    }
    if(point){
      point.color = MARKER_COLOR[colorName];
    }
}

function getRadioValue(radio) {
	if (!radio) {
		return "";
	}
	for (var i=0, len=radio.length; i<len; i++) {
		if (radio[i].checked) {
			return radio[i].value;
		}
	}
	return "";
}

function isRadioZoom() {
	return (getRadioValue(document.formSelectZoom.radSelectZoom) === "zoom");
}
	
// Read the public dataset into a format that can be used by the histogram
function parseData(args) {
	var xCol = args.xAxis;
     
	var dataSet = gadget.dashboard.getDataSet(args.dataSetId);
             
 	var graphData = [];
	for (i=0,len=dataSet.length(); i<len; i++) {
		var xVal = parseFloat(dataSet.getRecord(i)[selectedXAxis]);
		// each point has unique id so a pointer to point can be had by chart.get(id)
   	var id = dataSet.getRecord(i)["id"];
   	if (xVal !== NaN){
   		graphData.push({id: id, x: xVal, color: dataSet.getRecord(i).color });
  		}
  	}
  	
  	return graphData;
}
	
// Organize the data into an array of bins containing the data points
// Returns the array of bins along with an array of strings that describe
// the bounds of each bin
function makeBins(data) {
	// Find the extremes of the dataset
  var extremes = { min: Number.MAX_VALUE,
						  max: Number.MIN_VALUE };					  
	for (var i = 0; i < data.length; i++) {
		if (data[i].x < extremes.min)
			extremes.min = data[i].x;
		if (data[i].x > extremes.max)
			extremes.max = data[i].x;
	}

	// Create an array of length numBins and push data into each bin
	var obj = {bins: new Array(),
				  bounds: new Array() };		// The boundary values between each bin
	var boundNums = new Array();
	for (var i = 0; i < numBins; i++) {
		boundNums[i] = (((extremes.max - extremes.min)/numBins)*(i+1)+extremes.min).toFixed(3);
		obj.bins[i] = new Array();
	}
	for (var i = 0; i < data.length; i++) {
		var binToInsert = Math.floor(((data[i].x - extremes.min)/(extremes.max-extremes.min))*numBins);
		if (binToInsert == numBins)
			binToInsert = numBins-1;
		obj.bins[binToInsert].push(data[i]);
	}
	
	obj.bounds[0] = extremes.min.toFixed(3) + ' to ' + boundNums[0];
	for (var i = 1; i < numBins; i++) {
		obj.bounds[i] = boundNums[i-1] + ' to ' + boundNums[i];
	}
	
	return obj;
}
	
// Defines the highcharts object
function displayHistogram(args) {
chart1 = new Highcharts.Chart({
		chart: {
			renderTo: 'divChart1',
			animation: false,
			defaultSeriesType: 'column',
			zoomType: 'x',
			events: {
				selection: function(event) { handleSelectEvent(this,event); }
			}
		},
		title: {
			text: args.dataName
		},
		credits: {
         enabled: false
      },
      legend: {
      	layout: 'horizontal',
   	 	floating: false,
  	   	backgroundColor: '#FFFFFF',
 	    	align: 'left',
  	   	verticalAlign: 'top',
  	   	y: 60,
  	   	x: -60
      },
		xAxis: {
			categories: args.categories,
			tickmarkPlacement: 'between',
			labels: {
         	enabled: false
     		},
     		title: {
     			text: selectedXAxis
     		}
		},
		yAxis: {
			title: {
				text: 'Occurrences'
			}
		},
		plotOptions: {
     		series: {
         	groupPadding: 0,
         	pointPadding: 0
     		}
 		},
		series: [{
			name: args.dataName,
			data: args.series,
			showInLegend: false,
			animation: false,
			color: DEFAULT_MARKER_COLOR
		}]
	});
}

// What to do when a selection box is dragged across the chart
function handleSelectEvent(chart,event) {
	// If the radio button is set to zoom, click does nothing
	if (isRadioZoom())
		return;

	event.preventDefault();
	
	// Determine which bins the selection box falls onto
	var minBin = Math.floor(event.xAxis[0].min-0.5)+1;
	var maxBin = Math.floor(event.xAxis[0].max+0.5);
	
	// Select all of the bars in this range
	var modifiedPointIds = []
	for (var i = minBin; i <= maxBin; i++) {
		// Get the ids of every point contained in the selected bars
		for (var j = 0; j < bins[i].length; j++) {
			modifiedPointIds.push(bins[i][j].id);
		}
   }
   
   // Change the color of the points in the public database
   var selectionObj = {modifiedPointIds: modifiedPointIds, color: selectedColor };
	setSelectedColor(selectionObj);
	setTimeout(function() { gadget.notify('pointsSelected', selectionObj, {'private': true}) },1);
}
	
// Populates the X axis dropdown with values from the chosen datasets column names
// If no dataset is chosen, then it blanks them
function populateXSelect(datasetName) {
	var columnNames = [];
  var dataSet;
   if (datasetName) {
   	dataSet = gadget.dashboard.getDataSet(datasetName);
    columnNames = dataSet.getColumns();
	}
	populateSelect("selectXAxis", columnNames);
}
   
// Read the data from the public dataset and create the histogram   
function redraw() {
	
  numBins = document.getElementById('numBinsInput').value;
	   
  if (!selectedDataSetId || selectedXAxis === "") {
    alert("Choose a dataset and x axis");
   	return;
  }
   
  var selectedDataSetName = gadget.dashboard.getDataSet(selectedDataSetId).name;
  var dataInputObj = { 
    'dataSetId': selectedDataSetId,
    'xAxis': selectedXAxis 
  };
                   
  dataToChart = parseData(dataInputObj);
  var obj = makeBins(dataToChart);
  bins = obj.bins;
   
  var highchartsData = { 
    dataName: selectedDataSetName,
    categories: obj.bounds,
   	series: new Array() 
  };
  
  for (var i = 0; i < numBins; i++) {
   	var targetColor = DEFAULT_MARKER_COLOR;
   	for (var j = 0; j < bins[i].length; j++) {
   		if (bins[i][j].color!= SELECTED_MARKER_COLOR) {
   			targetColor = bins[i][j].color;
   		}
   	}
   	highchartsData.series[i] = { y: bins[i].length, color: targetColor };
  }
	
	displayHistogram(highchartsData);

}

</script>
</head>
<body>
<div id="content">
	<!-- The scatter plot -->
	<div id="divChart1" style="width: 600px; height: 400px; margin: 0 auto"></div>
	
	<!-- The plot controls -->
	<input id="btDoPlot" onclick="redraw();" type="button" value="Plot"/>
	Dataset: <select id="selectDataSetName"></select>
	X-Axis:  <select id="selectXAxis"></select><br>
	
	numBins: <input type="text" id="numBinsInput" value="10" /><br>
	<form name="formSelectZoom">
   	<div id="divSelectZoom" style="padding: 5px">
      	Selection Color: <select id="selectColor"></select>
         <input type="radio" id="radSelectZoom" name="radSelectZoom" value="select" checked="checked" /><label for="radSelect">Select</label>
         <input type="radio" id="radSelectZoom" name="radSelectZoom" value="zoom" /><label for="radZoom">Zoom</label>
   	</div>
	</form>
</div>
</body>
</html>