<?xml version="1.0" encoding="UTF-8"?>
<!-- plot_dataset.xml -->
<!-- Author: Ian Smith (imsmith@uw.edu) -->
<html lang="en">
<meta http-equiv="Pragma" content="no-cache">

<head>
<title>Plot View</title>

<!-- chart dependencies -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
<script src="/js/highcharts.src.js" type="text/javascript"></script>

<!-- ASCOT Basic Style Sheets -->
<link href="/css/960/reset.css" rel="stylesheet" type="text/css">
<link href="/css/960/text.css" rel="stylesheet" type="text/css"> 

<style type="text/css">

td{
  padding: 5px;
}

</style>

<script type="text/javascript">

var plot;
var axisInverted = {x: false, y: false};
var verboseTooltip = false;

var DEFAULT_MARKER_COLOR = 'rgba(100, 100, 100, .7)';
var MARKER_COLOR = {
  red: 'rgba(255, 0, 0, .7)',
  green: 'rgba(0, 255, 0, .7)',
  blue: 'rgba(0, 0, 255, .7)',
  yellow: 'rgba(220, 220, 0, .7)',
  unselect: 'rgba(100, 100, 100, .7)' 
};  


var chartOptions = {
  chart: {
    renderTo: 'divPlot',
    defaultSeriesType: 'scatter',
    zoomType: 'xy',
    events : {
      selection: function(event) {
      // check if the zoom or select radio is checked
      // also, only select if there is an xAxis property in event (allows reset zoom)
        if ($('#radioSelect').get(0).checked && ("xAxis" in event)) {
          event.preventDefault();
          var selectionObj = {'seriesId': 'series1', 'xMin': event.xAxis[0].min, 'xMax':  event.xAxis[0].max, 'yMin': event.yAxis[0].min, 'yMax':  event.yAxis[0].max, color: getSelectionMarkerColor()};
          gadget.dashboard.notify("pointsSelected", selectionObj);                                 
        }
      }
    }
  },
  credits: { enabled: false },
  title: { text: '' },
  loading: { showDuration: 0, hideDuration: 0 },
  xAxis: {
    title: { enabled: false, text: '' },
    reversed: axisInverted.x,
    startOnTick: true,
    endOnTick: true,
    showLastLabel: true
  },
  yAxis: {
    title: { text: '' },
    reversed: axisInverted.y
  },
  tooltip: {
    formatter: function() { return generateToolTip(this.x, this.y, this.point.id) }
  },
  plotOptions: {
    scatter: {
      animation: false,
      color: DEFAULT_MARKER_COLOR, 
      id: 'series1'                    
    }
  },
  series: [{
    name: '',
    data: [],
    point: {
      events: {
        click: function(event) {
          if (!(event.ctrlKey || event.metaKey)) { // check windows ctrl and mac meta
            // color point
            var selectedMarkerColor = getSelectionMarkerColor();
            if (getPointColor(this) !== selectedMarkerColor) {
              setPointColor(this, selectedMarkerColor);
            } 
            else {
              setPointColor(this, "");
            }
            plot.redraw();
          } 
          else { // zoom to point
            zoomToPoint(this); 
          }
        }
      }
    }
  }]
} 

function generateToolTip(xValue, yValue, pointId) {  
  var dataSet;
  var record;
  var info = [];
  if (verboseTooltip) {
      dataSet = gadget.dashboard.getDataSet(getSelectedDataset());
      record = dataSet.getRecord(pointId).toJSON();
      if (record){
        for (var prop in record) {
          info.push(prop + ": " + record[prop] + "<br/>");
        }
      }
      return info.join("");
  } 
  else {
    return plot.series[0].yAxis.options.title.text + ' : ' + yValue + '<br/>' + plot.series[0].xAxis.options.title.text +' : ' + xValue;
  }
}

// create new Plotter object
gadget.init = function(callback){
  
  gadget.dashboard.bind('dataSetChanged', redrawAll); 
  gadget.dashboard.bind('pointsSelected', setSelectedByMinMax);
  gadget.dashboard.bind('axisInverted', invertAxis);
  
  $("#checkVerboseInfo").change( function(){
    verboseTooltip = $("#checkVerboseInfo").get(0).checked;
  })
  
  // add colors to the select box (pass the select Name and color array)
  $('#selectDatasetName').change( function(){
    populateXYSelect($('#selectDatasetName option:selected').text());
  });
  $('#invertXAxisButton').click(invertX);
  $('#invertYAxisButton').click(invertY);
  $('#plotButton').click(drawPlot);
  $('#checkVerboseInfo').click(drawPlot);
  plot = new Highcharts.Chart(chartOptions);         
  setSelectOptions("selSelectionColor", ["red", "green", "blue", "yellow", "unselect"]);
  callback();
}
                                                                        
// When the list of public datasets change, rewrite the list of available datasets to plot    
function redrawAll(){
  setSelectOptions('selectDatasetName', gadget.dashboard.getDataSetList());
  drawPlot();
}

// GETS for the HTML controls on the page       
function getSelectedDataset() {
  return $('#selectDatasetName option:selected').text();
}

function getSelectedXAxis() {
  return $('#selXAxis option:selected').text();  
}

function getSelectedYAxis() {
  return $('#selYAxis option:selected').text();
}
  
function setSelectedByMinMax(obj) {
    
//debugLog('x: ' + xMin + ', ' + xMax + '\ny: ' + yMin + ', ' + yMax);
// 'select' all the points in the chart to change the way they look
var data = plot.get(obj.seriesId).data;
var ds = gadget.dashboard.getDataSet(getSelectedDataset());
var selectedIds = [];  
var selectedMarkerColor = obj.color; 

for (var i=0, len=data.length; i<len; i++){
  var point = data[i];
  if (point.x <= obj.xMax && point.x >= obj.xMin && point.y <= obj.yMax && point.y >= obj.yMin) {
    // point.id looks like: p0 
    // so we strip the first letter to get the db_id
    selectedIds.push(point.id);             
    colorChartPoint(point, selectedMarkerColor);
  }
}
plot.redraw();
var color = (selectedMarkerColor === "unselect") ? "" : selectedMarkerColor;

// update the dataset with the selected points
// set dataset points colors in bulk
ds.setRecordsMetaData({'color': color}, selectedIds);  

}

// Checks the public dataset to update the selection status of all the points in the chart
function updateSelectedPoints() {

  var colorIndexArray;
  var colorIndex;
  var ds;
  var point;

  if(plot == null)
    return;	
    
  plot.showLoading();
  // select or unselect all the points in the chart to change the way they look
  ds = gadget.dashboard.getDataSet(getSelectedDataset());
  if (ds === undefined || ds === null) {
    return;
  }
  colorIndexArray = ds.getIndex('color');
  // color selected points
  for (color in colorIndexArray){
    colorIndex = colorIndexArray[color];
    for (var j=0, lenj=colorIndex.length; j<lenj; j++){
      point = plot.get(colorIndex[j]);  // id is [0]
      if (point !== null) {
        colorChartPoint(point, color);  
      }
    }
  }
  plot.redraw();
  plot.hideLoading();
  
}

// Colors a selected point on chart by the color name
function colorChartPoint(point, colorName) {
  if (colorName === "") {
    colorName = "unselect";
  }
  point.update({color: MARKER_COLOR[colorName], marker: {fillColor: MARKER_COLOR[colorName]}}, false);
}

// colors chart point and writes it to dataset
function setPointColor(point, colorName) {
  
  if (colorName === "unselect") {
    colorName = "";
  }
  colorChartPoint(point, colorName);
  setTimeout( function() {
              var dataSetName = getSelectedDataset();
              var dataSet = gadget.dashboard.getDataSet(dataSetName);
              dataSet.setIndexesColor([point.id], colorName); }, 1 );            
}

// Zooms the viewport to point by writing CelestialCoordinate to public variable
function zoomToPoint(point) {
  var dataSet = gadget.dashboard.getDataSet(getSelectedDataset());
  var cc = dataSet.getRecord(point.id);
  if (cc !== null && cc !== undefined) {
    gadget.dashboard.notify("centerOfCoordinatesChanged",{'longitude': parseFloat(cc.get('ra')) - 180, 'latitude': parseFloat(cc.get('dec'))});
  }
}

function getPointColor(point) {
    var dataSet = gadget.dashboard.getDataSet(getSelectedDataset());
    return dataSet.getRecord(point.id);
}

function drawPlot() {
  
  var xAxisLabel = getSelectedXAxis();
  var yAxisLabel = getSelectedYAxis();
  var selectedDataSet = getSelectedDataset();
  var oldData;
  
  if (selectedDataSet ===  "" || xAxisLabel === "" || yAxisLabel === "") {
    alert("Choose a dataset, x axis, and y axis");
    return;
  }
  
  plot.setTitle({ text: selectedDataSet });
  plot.series[0].xAxis.options.title.text = xAxisLabel;
  plot.series[0].yAxis.options.title.text = yAxisLabel;
  plot.series[0].name = yAxisLabel + " vs " + xAxisLabel; 
  // Set Data + Redraw
  plot.series[0].setData(generatePoints(selectedDataSet, xAxisLabel, yAxisLabel), true);
  $('#divPlot').css('height', '400px');
  updateSelectedPoints();   
  showPlot(true);
  
}

function generatePoints(dataSetName, xAxisName, yAxisName){
  
  var xVal;
  var yVal;
  var id;
  var records = gadget.dashboard.getDataSet(dataSetName).getRecords();
  var shift;
  var points = [];
  if (dataSetName === "")
    return points;
  records = gadget.dashboard.getDataSet(dataSetName).getRecords(); 
  
  for (i=0,len=records.length; i<len; i++) {
    xVal = parseFloat(records[i].get(xAxisName));
    yVal = parseFloat(records[i].get(yAxisName));
    // each point has unique id so a pointer to point can be had by chart.get(id)
    id = records[i]["id"];
    if (xVal !== NaN && yVal !== NaN){
      points.push({'id': id,
                    x: xVal, 
                    y: yVal,
                    color: DEFAULT_MARKER_COLOR,
                    marker: { fillColor: DEFAULT_MARKER_COLOR }
                  });
    }
  }
  return points;
  
}    
// returns the color name in the selection color dropdown
function getSelectionMarkerColor() {
  return $('#selSelectionColor option:selected').text();
}

function showPlot(show) {
  if (show) {
     $('#divPlot').css('display', 'block');
  }
  else {
     $('#divPlot').css('display', 'hidden');
  }
	gadget.resize();
}

// Accepts the name of a select object, and an array of strings
// replaces the options with the array of strings
function setSelectOptions(selectName, options) {
    // Save old selected option so maybe it can be reselected
    var selectedOption = $('#' + selectName + ' option:selected').text();
    // Clear options
    $('#' + selectName + ' *').remove();
    // Populate options
    for (var i=0, len=options.length; i<len; i++) {
        $('#' + selectName).append('<option>' + options[i] + '</option>');
        if(selectedOption === options[i]){
          $('#' + selectName).val(options[i]).attr("selected", "selected");
        }
    }
    if(options.length!=0){
      if (!selectedOption){
        $('#' + selectName).val(options[0]).attr("selected", "selected");
	    }
    }
    $('#' + selectName).change();
}
    
function invertAxis(axis){
 
  if(axis === "x")
    axisInverted.x = !axisInverted.x;
  else
    axisInverted.y = !axisInverted.y;
  
  if (plot) {
    plot.xAxis.reversed = axisInverted.x;
    plot.yAxis.reversed = axisInverted.y 
    plot.redraw();
  }
  
}          

function invertX(){
  var value = $('#invertXAxisButton').text(); 
  if (value === '>') {
    $('#invertXAxisButton').text('<');
  } else {
    $('#invertXAxisButton').text('>');
  }
  gadget.dashboard.notify('axisInverted',"x")
}

function invertY(){
  var value = $('#invertYAxisButton').text(); 
   if (value === '^') {
     $('#invertYAxisButton').text('v');
   } else {
     $('#invertYAxisButton').text('^');
   }
  gadget.dashboard.notify('axisInverted',"y")
}

// Populates the X/Y axis dropdowns with values from the chosen datasets column names
// If no dataset is chosen, then it blanks them
function populateXYSelect(datasetName) {
  // TODO get dataset names
  var columnNames = [""];
  if (datasetName !== "") {
    var dataSet = gadget.dashboard.getDataSet(datasetName);
    columnNames = dataSet.getColumns();
  }
  setSelectOptions("selXAxis", columnNames);
  setSelectOptions("selYAxis", columnNames);
}
      
</script>
</head>
<body>
<div id="content">
  <div id="divSelectDataset" style="display: inline">  
    <table style="margin: 0px"><tbody>
      <tr>
        <td> Dataset: <select id="selectDatasetName"></select>
        </td>
        <td>    
          X Axis: <input id="invertXAxisButton" type="button" title="Invert X Axis" value=">"></input> <select id="selXAxis"></select>
        </td>
        <td>
          Y Axis: <input id="invertYAxisButton" type="button" title="Invert Y Axis" value="^"></input> <select id="selYAxis"></select>
        </td>
      </tr>
      <tr>
        <td>
          <input id="plotButton" type="button" value="Plot"/>
        </td> 
      </tr> 
    </tbody></table>
  </div>
  <div id="divPlotToolbar" style="display: inline">
    <form name="formSelectZoom">
        <div id="divSelectZoom" style="padding: 5px">
            Selection Color: <select id="selSelectionColor">
            </select>
            <input type="radio" id="radioSelect" name="radSelectZoom" value="select" checked="checked" /><label for="radSelect">Select</label>
            <input type="radio" id="radioZoom" name="radSelectZoom" value="zoom" /><label for="radZoom">Zoom</label>
            &nbsp;&nbsp; Info: <input type="checkbox" id="checkVerboseInfo" value="0"/>
        </div>
    </form>
  </div>
  <div id="divPlot" style="display: none"></div>
</div>
</body>
</html>