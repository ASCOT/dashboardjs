<?xml version="1.0" encoding="UTF-8" ?>
<!-- name_resolve.xml -->
<!-- Author: Ian Smith (imsmith@uw.edu) -->
<Module>
<ModulePrefs title="Name Resolve" 
    height="10"
    scrolling="true">
     <Require feature="dynamic-height"/>
     <Require feature="opensocial-0.9"/> 
     <Require feature="minimessage"/>
     <Require feature="settitle"/>
</ModulePrefs> 

<Content type="html"><![CDATA[


<!-- Astro scripts -->
<script src="/ascot/js/gadgetManager.js" type="text/javascript"></script>
<script src="/ascot/js/astroObjectLib.js" type="text/javascript"></script>

<!-- other scripts -->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="/ascot/js/jquery-1.4.3.min.js"></script>
<script type="text/javascript" src="/ascot/js/jquery.watermark.js"></script>

<link href="/ascot/css/reset.css" rel="stylesheet" type="text/css">
<link href="/ascot/css/gadgets.css" rel="stylesheet" type="text/css">

<div>
    <form name="form" style="height: 30px" action="#" onsubmit="tq.getCoords(document.getElementById('txtInputText').value);return false">
        <input type="text" id="txtInputText" style="width:15em;"/>
        <input type="submit" value="Go"/> e.g. "M67" or "190 00 00 -11 37 21.2"
    <div id="divStatusText" style="float:right;"></div> 
</div>

    </form>
</div>


<script type="text/javascript">
// HTML init
    $("#txtInputText").watermark("Enter object or RA and DEC");
</script>

<script type="text/javascript">

var tq = null;
var radec;
var flySpeed;

// create gadget object
function init(){
    gadgets.window.setTitle("Name Resolve");
    tq = new NameResolve();
    gadgets.window.adjustHeight();
    var gadget = new GM.Gadget("nameResolver");
    radec = gadget.addProperty("viewportCenterCoordinate");
    flySpeed = gadget.addProperty("viewportSpeed");
}

function NameResolve(){
    var my = new Object();
   
   // CONSTANTS
    
    
    // Status Icons
    var ICON_URL_SELECTED = '/ascot/gadgets/images/target_yellow.png',
        ICON_URL_DEFAULT = '/ascot/gadgets/images/target.png',
        ICON_URL_SPINNER = '/ascot/gadgets/images/spinnerGrey.gif',
        ICON_URL_ERROR = '/ascot/gadgets/images/errorIcon.gif',
        ICON_URL_SUCCESS = '/ascot/gadgets/images/successIcon.gif';

    var ICON = { SUCCESS : ICON_URL_SUCCESS,
              ERROR : ICON_URL_ERROR,
              SPINNER : ICON_URL_SPINNER,
              NONE : ""}
     
    function makeRequestGet(url) {
      params = {};
      params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.GET;
      // params[gadgets.io.RequestParameters.REFRESH_INTERVAL] = 0;
      // To turn off Google anti-refresh, add a "random" number so the
      // url is different every time
      var ts = new Date().getTime();
      var sep = "?";
      if (url.indexOf("?") > -1) sep = "&";
      url = [ url, sep, "nocache=", ts ].join("");
      gadgets.io.makeRequest(url, response, params);
    }

    // parse repsonse
    function response(obj) {
        if (!(typeof obj.text === "string")){
            showError('Unrecognized object.');
            return;
        }
        // a string was returned, but does it have relevant data in it?
        var dataLine = obj.text.match(/^%J.*$/gm);
        if (dataLine === null) {
            showError('Unrecognized object.');
            return;
        }
        dataLine=dataLine.toString();
        dataLine=dataLine.split(" ");
        radeg = dataLine[1]-0;
        newdec = dataLine[2]-0;
        
        var ra = radeg.toString();  //decimal hours
        var dec = newdec.toString();  //decimal degrees
        
        writeCoord(new UW.astro.CelestialCoordinate(ra, dec));
        
    }
    
    // METHODS
    
    // Parses text to get coordinates. 
    //  If text is RA and Dec, then it zooms to that coord
    //  Otherwise it asks the URL to resolve the text
    my.getCoords = function(text) {
        showSpinner("Parsing coordinate...");
        var cc = UW.astro.CelestialCoordinate.parseCoord(text);
        if (cc !== null) {
            // go to this cc
            writeCoord(cc);
        } else {
            showSpinner("Resolving object...");
            // ask the web service to parse it
            // make all spaces into plusses
            text = text.replace(/ /g, '+');
            makeRequestGet("http://cdsws.u-strasbg.fr/axis/services/Sesame?method=sesame&name="+text+"&resultType=p/c", 0);
        }
    }
    
    function writeCoord(cc) {
        showSuccess('<div style="float:right;">RA: ' + cc.getRa().toFixed(4) + "&deg<br />DEC: " + cc.getDec().toFixed(4) + "&deg</div>");
        flySpeed.value = 1.0;
        radec.value = cc;
    }

    // HELPER
    function clearStatus() {
        showStatus(ICON.NONE, "");
    }
    function showSpinner(text) {
        showStatus(ICON.SPINNER, text);
    }
    function showSuccess(text) {
        showStatus(ICON.SUCCESS, text);
    }
    function showError(text) {
        showStatus(ICON.ERROR, text);
    }
    function showStatus(iconUrl, text){
        if (iconUrl !== ICON.NONE) {
            setStatus( '<img id="imgStatus" src="' + iconUrl + '" /> ' + text);
        } else {
            setStatus(text);
        }
    }
    function setStatus(text) {
        // set text status
        statusDiv = document.getElementById('divStatusText');
        statusDiv.innerHTML = text;
        // make visible
        statusDiv.style.visibility = 'block';
    }
    
    function xmlStringToDoc(text){
        if (window.DOMParser){
            parser=new DOMParser();
            xmlDoc=parser.parseFromString(text,"text/xml");
        }
        else // Internet Explorer
        {
            xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
            xmlDoc.async="false";
            xmlDoc.loadXML(text); 
        } 
        // TODO: test to verify its created
        return xmlDoc;
    }

    return my;
}

gadgets.util.registerOnLoadHandler(init); 


</script>


]]></Content>
</Module>
