<?xml version="1.0" encoding="UTF-8" ?>
<!-- data_table.xml -->
<!-- Author: Ian Smith (imsmith@uw.edu) -->
<Module>

<ModulePrefs title="Data Table"
    height="10"
    scrolling="true">
     <Require feature="dynamic-height"/>
     <Require feature="opensocial-0.8"/> 
     <Require feature="minimessage"/>
     <Require feature="settitle"/>
</ModulePrefs> 
<Content type="html"><![CDATA[

<script src="/ascot/js/astroObjectLib.js" type="text/javascript"></script>
<script src="/ascot/js/dataset.js" type="text/javascript"></script>
<script src="/ascot/js/gadgetManager.js" type="text/javascript"></script>


<!-- Combo-handled YUI CSS files: -->
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/combo?2.8.1/build/fonts/fonts-min.css&2.8.1/build/grids/grids-min.css&2.8.1/build/base/base-min.css&2.8.1/build/paginator/assets/skins/sam/paginator.css&2.8.1/build/datatable/assets/skins/sam/datatable.css">
<!-- Combo-handled YUI JS files: -->
<script type="text/javascript" src="http://yui.yahooapis.com/combo?2.8.1/build/yahoo/yahoo.js&2.8.1/build/dom/dom.js&2.8.1/build/event/event.js&2.8.1/build/dragdrop/dragdrop.js&2.8.1/build/element/element.js&2.8.1/build/paginator/paginator.js&2.8.1/build/datasource/datasource.js&2.8.1/build/datatable/datatable.js&2.8.1/build/selector/selector.js"></script>


<style type="text/css">
#divTable { 
        text-align: center; 
} 
#divTable table { 
        margin-left:auto; margin-right:auto; 
} 
#divTable, ##divTable .yui-dt-loading { 
        text-align: center; background-color: transparent; 
}
#divSelectDataset { 
        text-align: left
}
.yui-skin-sam .yui-dt-liner { white-space:nowrap; } 
</style>

<div id="divGadget"  class="yui-skin-sam" style="overflow:auto">
        <div id="divSelectDataset">
                Dataset: <select id="selDatasetName" onchange="myGadget.chooseDataset(this.options[this.selectedIndex].value);">
                         </select>
        </div>
        <div id="divTable" style="width:100%; overflow:auto;">
        </div>
</div>


<script type="text/javascript">

var myGadget = null;

var dataSetList;

// Creates gadget object
function init(){
    gadgets.window.setTitle("Data Table");
    
    gadget = new GM.Gadget("tableView");
    dataSetList = gadget.addProperty("dataSetList");
    
    myGadget = new dataTable();
    gadgets.window.adjustHeight();
     
}


function dataTable(){
    var my = new Object();
        
    // INIT
    dataSetList.bind("dataInquirer", "dataSetList", updateDataSetList);
	  dataSetList.bind("dataSetSelector", "dataSetList", updateDataSetList);
    
    // ** Variables to register go in this array.                             
      
    // METHODS
    // ** Add public methods (that will be called from outside the object by a button or something) 
    my.chooseDataset = function(datasetName) {
        updateTable();
    }
            
    function updateTable() {
        var datasetName = getSelectedDataset();     
        var tableDiv = "divTable";
        var ds = dataSetList.value[datasetName];
        if (ds === undefined || ds === null) {
            return;
        }
        var columnNames = sortColumns(ds.getColumns());     // custom column order for this table
        var myDataSource = new YAHOO.util.DataSource(ds.toJSON());
        var myColumnDefs = [];
        for (var i=0, len=columnNames.length; i<len; i++) {
            var obj = {};
            obj.key = columnNames[i];
            obj.label = columnNames[i];
            obj.sortable = true;
            myColumnDefs.push(obj);
        }

        var width = document.getElementById(tableDiv).offsetWidth;
        myDataSource.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
        var oConfigs = {
                paginator: new YAHOO.widget.Paginator({
                        rowsPerPage: 12
                }),
                width: width+"px",
                height: "400px",
                draggableColumns: true
        };
                        
                        
        var myDataTable = new YAHOO.widget.DataTable(tableDiv, myColumnDefs, myDataSource, oConfigs);

        // need to set the height to 80px plus div height in order to get a horiz scroll bar    
        gadget.resize();

    }

    function sortColumns(cols) {
        moveStringToStart(cols, "db_id");
        moveStringToStart(cols, "db_color");
        moveStringToStart(cols, "dec");
        moveStringToStart(cols, "ra");
        return cols;
    }

    // finds the first element=elem and moves it to the start of the array
    function moveStringToStart(arr, elem) {
        for (var i=0, len=arr.length; i<len; i++) {
            if (typeof arr[i] === 'string' && arr[i].toLowerCase() === elem.toLowerCase()) {
                moveIndexToStart(arr, i);
                break;
            }
        }
        return arr;
    }
    
    // moves element at index of arr to the beginning of the array
    function moveIndexToStart(arr, index) { 
        var elem = arr[index];
        arr.splice(index, 1);
        arr.unshift(elem);
        return arr;
    }
    
    function updateDataSetList(){
        var list = dataSetList.value;
        var select = document.getElementById("selDatasetName");
        // save old selected option so maybe it can be reselected
        var oldOpt = getSelectedOption("selDatasetName");
        // clear options
        for (var i=select.length-1; i>=0; i--) {
            select.remove(i);
        }
         for (var dataSetName in list){
            select.add(new Option(dataSetName, dataSetName, false, (oldOpt === dataSetName)), null);
        }
         if(select.onchange)
        	select.onchange();
    }

    function getSelectedOption(select) {
        var selName = document.getElementById(select);
        if (selName.length > 0){
            return selName.options[selName.selectedIndex].value;
        } else {
            return "";
        }
    }
        
    function getSelectedDataset() {
        return getSelectedOption("selDatasetName");
    }


   
    return my;
}

gadgets.util.registerOnLoadHandler(init); 

</script>

]]></Content>
</Module>

