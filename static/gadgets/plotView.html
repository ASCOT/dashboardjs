<!-- Author: Ian Smith (imsmith@uw.edu) -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Pragma" content="no-cache">
<title>Plot View</title>

<!-- chart dependencies -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js" type="text/javascript"></script>
<script src="/highcharts.src.js" type="text/javascript"></script>

<!-- ASCOT Basic Style Sheets -->
<link href="/css/reset.css" rel="stylesheet" type="text/css">
<link href="/css/text.css" rel="stylesheet" type="text/css"> 

<style type="text/css">
td{
  padding: 5px;
}
</style>

<script type="text/javascript">

// Constants
var DEFAULT_MARKER_COLOR = 'rgba(100, 100, 100, .7)';
var MARKER_COLOR = {
  red: 'rgba(255, 0, 0, .7)',
  green: 'rgba(0, 255, 0, .7)',
  blue: 'rgba(0, 0, 255, .7)',
  yellow: 'rgba(220, 220, 0, .7)',
  unselect: 'rgba(100, 100, 100, .7)' 
};  

// Highcharts plot
var plot;

// Gadget sate
var axisInverted = {x: false, y: false};
var verboseTooltip = false;
var selectedDataSetName = "";
var selectedXAxis = "";
var selectedYAxis = "";
var selectedColor = "";
var selectedDataSet;

// Gadget intialization
gadget.init = function(callback){
  
  gadget.dashboard.bind('dataSetChanged', redrawAll); 
  gadget.dashboard.bind('pointsSelected', setSelectedByMinMax);
  gadget.dashboard.bind('axisInverted', invertAxis);
  
  $("#checkVerboseInfo").change( function(){
    verboseTooltip = $("#checkVerboseInfo").get(0).checked;
  })
  
  // add colors to the select box (pass the select Name and color array)
  $('#selectDatasetName').change( function(){
    if(this.selectedIndex != -1){
      selectedDataSetName = this[this.selectedIndex].value;
      selectedDataSet = gadget.dashboard.getDataSet(selectedDataSetName);
      if(selectedDataSet){
        columnNames = selectedDataSet.getColumns();
        populateSelect("selectXAxis", columnNames);
        populateSelect("selectYAxis", columnNames);
      }
    }    
  });
  
  $('#selectXAxis').change( function(){
    if(this.selectedIndex != -1){
      selectedXAxis = this[this.selectedIndex].value;
    }
  });
  
  $('#selectYAxis').change( function(){
    if(this.selectedIndex != -1){
      selectedYAxis = this[this.selectedIndex].value;
    }
  });
  
  $('#selSelectionColor').change( function(){
    if(this.selectedIndex != -1){
      selectedColor = this[this.selectedIndex].value;
    }
  });  
    
  $('#invertXAxisButton').click(invertX);
  $('#invertYAxisButton').click(invertY);
  $('#plotButton').click(drawPlotClicked);
  plot = new Highcharts.Chart(chartOptions);         
  populateSelect("selSelectionColor", ["red", "green", "blue", "yellow", "unselect"]);
  callback();
}

// Highcharts plot options
var chartOptions = {
  chart: {
    renderTo: 'divPlot',
    defaultSeriesType: 'scatter',
    zoomType: 'xy',
    events : {
      selection: function(event) {
      // check if the zoom or select radio is checked
      // also, only select if there is an xAxis property in event (allows reset zoom)
        if ($('#radioSelect').get(0).checked && ("xAxis" in event)) {
          event.preventDefault();
          var selectionObj = {'seriesId': 'series1', 'xMin': event.xAxis[0].min, 'xMax':  event.xAxis[0].max, 'yMin': event.yAxis[0].min, 'yMax':  event.yAxis[0].max, color: selectedColor};
          gadget.dashboard.notify("pointsSelected", selectionObj);                                 
        }
      }
    }
  },
  credits: { enabled: false },
  legend: { enabled: false},
  title: { text: '' },
  loading: { showDuration: 0, hideDuration: 0 },
  xAxis: {
    title: { enabled: false, text: '' },
    reversed: false,
    startOnTick: true,
    endOnTick: true,
    showLastLabel: true
  },
  yAxis: {
    title: { text: '' },
    reversed: false
  },
  tooltip: {
    formatter: function() { return generateToolTip(this.x, this.y, this.point.id) }
  },
  plotOptions: {
    scatter: {
      animation: false,
      color: DEFAULT_MARKER_COLOR, 
      id: 'series1'                    
    }
  },
  series: [{
    name: '',
    data: [],
    point: {
      events: {
        click: function(event) {
          if (!(event.ctrlKey || event.metaKey)) { // check windows ctrl and mac meta
            // color point
            var selectedMarkerColor = selectedColor;
            if (getPointColor(this) !== selectedMarkerColor) {
              setPointColor(this, selectedMarkerColor);
            } 
            else {
              setPointColor(this, "");
            }
            plot.redraw();
          } 
          else { // zoom to point
            zoomToPoint(this); 
          }
        }
      }
    }
  }]
} 

function generateToolTip(xValue, yValue, pointId) {  
  var dataSet;
  var record;
  var info = [];
  if (verboseTooltip) {
      record = selectedDataSet.getRecord(pointId).toJSON();
      if (record){
        for (var prop in record) {
          info.push(prop + ": " + record[prop] + "<br/>");
        }
      }
      return info.join("");
  } 
  else { 
    return  $(plot.yAxis[0].axisTitle.element).text() + ' : ' + yValue + '<br/>' + $(plot.xAxis[0].axisTitle.element).text()  +' : ' + xValue;
  }
}


function drawPlotClicked(){
  if (selectedDataSetName ===  "" || selectedXAxis === "" || selectedYAxis === "") {
    alert("Choose a dataset, x axis, and y axis");
    return;
  }
  else{
    drawPlot();
  }
}
                                                                        
function redrawAll(){
  var columnNames = [];
  populateSelect('selectDatasetName', gadget.dashboard.getDataSetList());
  if(selectedDataSet){
    columnNames = selectedDataSet.getColumns();
    populateSelect("selectXAxis", columnNames);
    populateSelect("selectYAxis", columnNames);
  }
  drawPlot();
}
  
function setSelectedByMinMax(obj) {
  //debugLog('x: ' + xMin + ', ' + xMax + '\ny: ' + yMin + ', ' + yMax);
  // 'select' all the points in the chart to change the way they look
  var data = plot.get(obj.seriesId).data;
  var selectedIds = [];  
  var selectedMarkerColor = obj.color; 
  var point;
  var color;
  var i;

  for (i=0, len=data.length; i<len; i++){ 
    point = data[i];
    if (point.x <= obj.xMax && point.x >= obj.xMin && point.y <= obj.yMax && point.y >= obj.yMin) {
      // point.id looks like: p0 
      // so we strip the first letter to get the db_id
      selectedIds.push(point.id);             
      colorChartPoint(point, selectedMarkerColor);
    }
  }
  plot.redraw();
  color = (selectedMarkerColor === "unselect") ? "" : selectedMarkerColor;
  // update the dataset with the selected points 
  // set dataset points colors in bulk
  selectedDataSet.setRecordsMetaData({'color': color}, selectedIds);  
}

// Checks the public dataset to update the selection status of all the points in the chart
function updateSelectedPoints() {
  var colorIndexArray;
  var colorIndex;
  var point;

  if(plot == null)
    return;	
    
  plot.showLoading();
  // select or unselect all the points in the chart to change the way they look
  if (!selectedDataSet) {
    return;
  }
  colorIndexArray = selectedDataSet.getIndex('color');
  // color selected points
  for (color in colorIndexArray){
    colorIndex = colorIndexArray[color];
    for (var j=0, lenj=colorIndex.length; j<lenj; j++){
      point = plot.get(colorIndex[j]);  // id is [0]
      if (point !== null) {
        colorChartPoint(point, color);  
      }
    }
  }
  plot.hideLoading();
}

// Colors a selected point on chart by the color name
function colorChartPoint(point, colorName) {
  if (colorName === "") {
    colorName = "unselect";
  }
  point.update({color: MARKER_COLOR[colorName], marker: {fillColor: MARKER_COLOR[colorName]}}, false);
}

// colors chart point and writes it to dataset
function setPointColor(point, colorName) {
  if (colorName === "unselect") {
    colorName = "";
  }
  colorChartPoint(point, colorName);
  selectedDataSet.setRecordsMetaData({'color': colorName}, point.id);  
}

// Zooms the viewport to point by writing CelestialCoordinate to public variable
function zoomToPoint(point) {
  var cc = selectedDataSet.getRecord(point.id);
  if (cc !== null && cc !== undefined) {
    gadget.dashboard.notify("centerOfCoordinatesChanged",{'longitude': parseFloat(cc.ra) - 180, 'latitude': parseFloat(cc.dec)});
  }
}

function getPointColor(point) {
  return selectedDataSet.getRecord(point.id);
}

function drawPlot() {
  if (selectedDataSetName ===  "" || selectedXAxis === "" || selectedYAxis === "") {
    return;
  }
  plot.setTitle({ text: selectedDataSetName });
  
  // Set Data + Axis labels + Redraw
  if(plot.xAxis[0].axisTitle && plot.xAxis[0].axisTitle){
     $(plot.xAxis[0].axisTitle.element).text(selectedXAxis);
     $(plot.yAxis[0].axisTitle.element).text(selectedYAxis);
  }
  else{
    plot.series[0].xAxis.options.title.text = selectedXAxis;
    plot.series[0].yAxis.options.title.text = selectedYAxis;
  }
  // Legend
  //$(plot.series[0].legendItem.element).text(yAxisLabel + " vs " + xAxisLabel)
  plot.series[0].setData(generatePoints(), true);

  $('#divPlot').css('height', '400px');
  updateSelectedPoints(); 
  showPlot(true); 
}

function generatePoints(){
  var xVal;
  var yVal;
  var id;
  var records;
  var shift;
  var points = [];
  if (!selectedDataSet)
    return points;
  records = selectedDataSet.getRecords(); 
  
  for (i=0,len=records.length; i<len; i++) {
    xVal = parseFloat(records[i][selectedXAxis]);
    yVal = parseFloat(records[i][selectedYAxis]);
    // each point has unique id so a pointer to point can be had by chart.get(id)
    id = records[i]["id"];
    if (xVal !== NaN && yVal !== NaN){
      points.push({'id': id,
                    x: xVal, 
                    y: yVal,
                    color: DEFAULT_MARKER_COLOR,
                    marker: { fillColor: DEFAULT_MARKER_COLOR }
                  });
    }
  }
  return points;
}    

function showPlot(show) {
  if (show) {
    $('#divPlot').css('display', 'block');
  }
  else {
    $('#divPlot').css('display', 'hidden');
  }
	gadget.resize();
}

function populateSelect(selectName, options) { 
  var html = '';
  var currentSelection = $("#" + selectName + " option:selected").text();
  var len = options.length;
  var keepSelection = false;
  for (var i = 0; i< len; i++) {
    if (options[i]===currentSelection){
      keepSelection = true;
    }
    html += '<option value="' + options[i] + '">' + options[i] + '</option>';
  }
  $("#" + selectName).html(html);
  if(keepSelection){
    $("#" + selectName).val(currentSelection).attr('selected',true);    
  }
  $('#' + selectName).change();
}
    
function invertAxis(axis){
  if(axis === "x")
    axisInverted.x = !axisInverted.x;
  else
    axisInverted.y = !axisInverted.y;
  
  if (plot) {
    plot.xAxis[0].reversed = axisInverted.x;
    plot.yAxis[0].reversed = axisInverted.y;
  }
  drawPlot();
}          

function invertX(){
  var value = $('#invertXAxisButton').text(); 
  if (value === '>') {
    $('#invertXAxisButton').text('<');
  } else {
    $('#invertXAxisButton').text('>');
  }
  gadget.dashboard.notify('axisInverted',"x")
}

function invertY(){
  var value = $('#invertYAxisButton').text(); 
   if (value === '^') {
     $('#invertYAxisButton').text('v');
   } else {
     $('#invertYAxisButton').text('^');
   }
  gadget.dashboard.notify('axisInverted',"y")
}
      
</script>
</head>
<body>
<div id="content">
  <div id="divSelectDataset" style="display: inline">  
    <table style="margin: 0px"><tbody>
      <tr>
        <td> Dataset: <select id="selectDatasetName"></select>
        </td>
        <td>    
          X Axis: <input id="invertXAxisButton" type="button" title="Invert X Axis" value=">"></input> <select id="selectXAxis"></select>
        </td>
        <td>
          Y Axis: <input id="invertYAxisButton" type="button" title="Invert Y Axis" value="^"></input> <select id="selectYAxis"></select>
        </td>
      </tr>
      <tr>
        <td>
          <input id="plotButton" type="button" value="Plot"/>
        </td> 
      </tr> 
    </tbody></table>
  </div>
  <div id="divPlotToolbar" style="display: inline">
    <form name="formSelectZoom">
      <div id="divSelectZoom" style="padding: 5px">
        Selection Color: <select id="selSelectionColor"></select>
        <input type="radio" id="radioSelect" name="radSelectZoom" value="select" checked="checked" /><label for="radSelect">Select</label>
        <input type="radio" id="radioZoom" name="radSelectZoom" value="zoom" /><label for="radZoom">Zoom</label>
        Info: <input type="checkbox" id="checkVerboseInfo" value="0"/>
      </div>
    </form>
  </div>
  <div id="divPlot" style="display: none"></div>
</div>
</body>
</html>