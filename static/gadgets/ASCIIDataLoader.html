<?xml version="1.0" encoding="UTF-8"?>
<!-- get_data.xml -->
<!-- Author: Spencer Wallace (spencerw@email.arizona.edu) -->
<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Pragma" content="no-cache">

<head>
<title>ASCII Data Loader</title>

<!-- chart dependencies -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js" type="text/javascript"></script>
<script src="../js/highcharts/highcharts.js" type="text/javascript"></script>

<!-- ASCOT Basic Style Sheets -->
<link href="/css/reset.css" rel="stylesheet" type="text/css">
<link href="/css/text.css" rel="stylesheet" type="text/css"> 

<script type="text/javascript">

// The gadget
var ga = null;

// Create the Histogram object
function init() {
	ga = new ASCIIDataLoader();
	gadget.resize();
}

function ASCIIDataLoader() {
	var my = new Object();
	
	var textFile = '';							// The text that was read in from the ASCII file
	var numDatapoints;							// The number of datapoints to extract from the text file
	
	// Status Icons
    var ICON_URL_SELECTED = '/images/targetYellow.png',
        ICON_URL_DEFAULT = '/images/target.png',
        ICON_URL_SPINNER = '/images/spinnerGrey.gif',
        ICON_URL_ERROR = '/images/errorIcon.gif',
        ICON_URL_SUCCESS = '/images/successIcon.gif';

    var ICON = { SUCCESS : ICON_URL_SUCCESS,
              ERROR : ICON_URL_ERROR,
              SPINNER : ICON_URL_SPINNER,
              NONE : ""}
	
	// Create a dataset object from the data array
   function createDataset() {
   	
   	var stepCount = 0;
   	
   	textFile = textFile.split('\n');
   	var dataStepSize = Math.floor(textFile.length/numDatapoints);
   	if (dataStepSize == 0)
   		dataStepSize = 1;
   	textFile[0] = textFile[0].split(' ');
   	var json = [];
   	// Row 0 is holds the attribute names
   	for (var i = 1; i < textFile.length-1; i++) {
   		
   		if (stepCount == 0 || stepCount == dataStepSize) {
   			textFile[i] = textFile[i].split(' ');
   			var elem = {};
   			// loop through attributes
   			for (var j=0; j < textFile[i].length; j++) {
   				var attName = textFile[0][j];
   				var attValue = textFile[i][j];
   				elem[attName] = attValue;
   			}
   			json.push(elem);
   			stepCount = 0;
   		}
   		stepCount++;
   	}
   	
   	if (json.length == 0){
            // the special case answer is that no rows were returned
            showError('No objects found');
            return;
        }
   	
   	// indicate status to user
      showSuccess("Returned " + json.length + " records.");

  	 	// create dataset
  		var ds = gadget.dashboard.createDataSet(document.getElementById('datasetNameInput').value); 
   	ds.init(json);
   }
	
	// HELPER
    function clearStatus() {
        showStatus(ICON.NONE, "");
    }
    function showSpinner(text) {
        showStatus(ICON.SPINNER, text);
    }
    function showSuccess(text) {
        showStatus(ICON.SUCCESS, text);
    }
    function showError(text) {
        showStatus(ICON.ERROR, text);
    }
     
    function showStatus(iconUrl, text){
        if (iconUrl !== ICON.NONE) {
            setStatus( '<img id="imgStatus" style="vertical-align:middle;" src="' + iconUrl + '" /> ' + "<span style='vertical-align:middle;'>" + text + "</span>");
        } else {
            setStatus(text);
        }
    }
   
    function setStatus(text) {
        // set text status
        var statusDiv = document.getElementById('divStatusText');
        statusDiv.innerHTML = text;
        // make visible
        statusDiv.style.visibility = 'inline';
    }
	
	// PUBLIC METHODS
	my.loadFile = function(files) {
    	file = files[0];
    	var reader = new FileReader();
    	reader.onload = function(e) {
      	textFile = e.target.result;
    	}
    	reader.readAsText(file);
  	}
  	
  	my.initColumns = function() {
  		showSpinner("Getting objects..."); 
  		var dsName = document.getElementById('datasetNameInput').value;
  		if (dsName.length < 1) {
            showError("Enter dataset name");
            return;
        }
  		numDatapoints = document.getElementById('numDatapointsInput').value;
  		createDataset();
  	}
	
	return my;
}

</script>
</head>
<body onload="init();">
<div id="content">
	Dataset Name: <input id="datasetNameInput"> <br>
	# of Points to Extract: <input id="numDatapointsInput" value="5000">
	<input type="file" onchange="ga.loadFile(this.files)"> <br>
	<input type="button" value="Submit" onclick="ga.initColumns();"> <br>
	<div id="divStatusText" style="display: inline; margin-left: 10px"></div> 
</div>
</body>
</html>
